<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI 综述领航员：基于 SPARK 工作流的科研综述助手，集成 OpenAlex 检索与 SiliconFlow LLM。">
    <title>AI 综述领航员 (V4.7 整合版)</title>

    <!-- 预连接加速 CDN 资源加载 -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdn.plot.ly" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

    <!-- 1. 核心库 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- 2. Tailwind 配置 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0b1120', 800: '#1e293b', 700: '#334155' }
                    }
                }
            },
            safelist: [
                'bg-blue-500', 'bg-orange-500', 'bg-purple-500', 'bg-slate-500', 'bg-emerald-500',
                'text-blue-400', 'text-orange-400', 'text-purple-400', 'text-slate-400', 'text-emerald-400',
                'bg-blue-900/30', 'bg-orange-900/30', 'bg-purple-900/30', 'bg-slate-800', 'bg-emerald-900/30',
                'border-l-4', 'border-yellow-500', 'border-green-500', 'border-blue-500', 'ring-1', 'ring-purple-500'
            ]
        }
    </script>
    <link rel="stylesheet" href="./src/styles.css" />
</head>
<body class="h-screen flex overflow-hidden">

    <noscript>
        <div style="padding: 16px; background: #0f172a; color: #f8fafc; text-align: center; width: 100%;">
            需要开启 JavaScript 才能运行 AI 综述领航员。
        </div>
    </noscript>

    <div id="error-overlay">
        <h1 class="text-2xl font-bold mb-4">程序启动失败</h1>
        <pre id="error-msg"></pre>
        <p class="mt-4 text-white">请尝试刷新页面，或检查网络连接（CDN加载失败）。</p>
    </div>

    <div id="app" class="flex w-full h-full" v-cloak>
        <!-- Sidebar -->
        <aside class="w-64 bg-[#0f172a] border-r border-slate-800 flex flex-col flex-shrink-0 z-20">
            <div class="h-16 flex items-center px-6 border-b border-slate-800">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center mr-3 shadow-lg shadow-blue-500/30">
                    <i class="ph ph-sparkle text-white text-xl"></i>
                </div>
                <span class="text-lg font-bold text-white tracking-wide">AI 综述领航员</span>
            </div>

            <nav class="flex-1 py-6 space-y-1 overflow-y-auto">
                <div @click="view = 'dashboard'" :class="['sidebar-link', view === 'dashboard' ? 'active' : '']">
                    <i class="ph ph-folder-open text-xl mr-3"></i>
                    <span class="font-medium">项目管理</span>
                </div>

                <div class="px-6 mt-8 mb-2 text-xs font-bold text-slate-500 uppercase tracking-wider">SPARK 工作流</div>
                <div v-for="step in STEPS_CONFIG" :key="step.id"
                     @click="scrollToStep(step.id)"
                     :class="['sidebar-link', (view === 'workspace' && currentStep === step.id) ? 'active' : '']">
                    <i :class="['text-xl mr-3', step.icon]"></i>
                    <span>{{ step.shortTitle }}</span>
                </div>
            </nav>

            <div class="p-4 border-t border-slate-800 bg-[#0f172a]">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-xs text-slate-500">API 配置 (SiliconFlow)</div>
                    <button @click="showKey = !showKey" class="text-slate-500 hover:text-white"><i :class="showKey ? 'ph ph-eye-slash' : 'ph ph-eye'"></i></button>
                </div>
                <input v-model="apiKey" :type="showKey ? 'text' : 'password'" placeholder="输入 sk-..." 
                       class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-xs text-white focus:border-blue-500 outline-none mb-2 transition-colors">
                <button @click="testConnection" class="w-full bg-slate-700 hover:bg-slate-600 text-white text-xs py-1.5 rounded transition-colors flex items-center justify-center gap-2">
                    <i class="ph ph-plugs-connected"></i> 测试连接
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0 bg-[#0b1120] relative">
            <header class="h-16 bg-[#0f172a] border-b border-slate-800 flex items-center justify-between px-8 shadow-sm flex-shrink-0 z-10">
                <div class="flex items-center">
                    <button v-if="view === 'workspace'" @click="view = 'dashboard'" class="mr-4 text-slate-400 hover:text-blue-400 transition-colors">
                        <i class="ph ph-arrow-left text-xl"></i>
                    </button>
                    <h2 class="text-lg font-bold text-slate-100 truncate max-w-md">
                        {{ view === 'dashboard' ? '项目管理中心' : (activeProject.title || '新项目工作台') }}
                    </h2>
                </div>
                <div class="flex items-center gap-4">
                    <button v-if="view === 'workspace'" @click="exportReport" class="text-sm text-slate-400 hover:text-blue-400 flex items-center gap-1 px-3 py-1.5 rounded hover:bg-slate-800 transition-colors">
                        <i class="ph ph-download-simple text-lg"></i> 导出报告
                    </button>
                    <span v-if="loading" class="text-sm text-blue-400 flex items-center bg-blue-900/30 px-3 py-1 rounded-full border border-blue-800">
                        <i class="ph ph-spinner animate-spin mr-2"></i> {{ loadingText }}
                    </span>
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 text-white flex items-center justify-center font-bold text-sm border border-slate-700">
                        U
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8 scroll-smooth" id="mainScroll">
                <!-- Dashboard -->
                <div v-if="view === 'dashboard'" class="max-w-6xl mx-auto animate-fade-in">
                    <div class="bg-gradient-to-r from-blue-900 to-slate-900 rounded-2xl p-8 border border-blue-800/50 shadow-2xl mb-8 flex justify-between items-center relative overflow-hidden">
                        <div class="absolute top-0 right-0 opacity-20 pointer-events-none">
                            <i class="ph ph-sparkle text-9xl transform translate-x-10 -translate-y-10 text-blue-500"></i>
                        </div>
                        <div class="relative z-10">
                            <h1 class="text-2xl font-bold mb-2 text-white">SPARK 2.0 科研逻辑引擎</h1>
                            <p class="text-blue-200 opacity-80 max-w-xl">基于全维科研评价标准 (Subject, Problem, Approach, Reference, Key Result)，打造深度循证综述。</p>
                        </div>
                        <button @click="createNewProject" class="relative z-10 bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-500 transition-all flex items-center gap-2">
                            <i class="ph ph-plus-circle text-xl"></i> 新建项目
                        </button>
                    </div>

                    <div class="glass-card overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/50">
                            <h3 class="font-bold text-slate-200">项目列表 ({{ projectList.length }})</h3>
                            <button @click="clearAllProjects" class="text-xs text-red-400 hover:text-red-300 flex items-center gap-1">
                                <i class="ph ph-trash"></i> 清空
                            </button>
                        </div>
                        <div v-if="projectList.length === 0" class="p-16 text-center text-slate-500">
                            <i class="ph ph-folder-dashed text-5xl mb-4 opacity-30"></i>
                            <p>暂无项目，请点击上方按钮新建</p>
                        </div>
                        <table v-else class="w-full text-left text-sm text-slate-400">
                            <thead class="bg-slate-900/50 text-xs uppercase font-medium text-slate-500">
                                <tr>
                                    <th class="px-6 py-3">项目名称</th>
                                    <th class="px-6 py-3">当前阶段</th>
                                    <th class="px-6 py-3">更新时间</th>
                                    <th class="px-6 py-3 text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-700">
                                <tr v-for="p in projectList" :key="p.id" class="hover:bg-slate-800/50 transition-colors group">
                                    <td class="px-6 py-4 font-medium text-slate-200 cursor-pointer" @click="loadProject(p.id)">
                                        {{ p.title || '未命名项目' }}
                                    </td>
                                    <td class="px-6 py-4 cursor-pointer" @click="loadProject(p.id)">
                                        <span :class="['px-2 py-1 rounded-full text-xs font-bold whitespace-nowrap', getStepColor(p.step)]">
                                            {{ getStepName(p.step) }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 cursor-pointer" @click="loadProject(p.id)">{{ formatDate(p.updatedAt) }}</td>
                                    <td class="px-6 py-4 text-right flex items-center justify-end gap-3">
                                        <button @click.stop="renameProject(p.id)" class="text-slate-500 hover:text-blue-400" title="重命名">
                                            <i class="ph ph-pencil-simple text-lg"></i>
                                        </button>
                                        <button @click.stop="deleteProject(p.id)" class="text-slate-500 hover:text-red-400" title="删除">
                                            <i class="ph ph-trash text-lg"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Workspace -->
                <div v-if="view === 'workspace'" class="max-w-6xl mx-auto pb-20 animate-fade-in">
                    <!-- Step 1: 广角镜 -->
                    <div id="step-1" :class="['step-card', currentStep === 1 ? 'active' : (currentStep > 1 ? 'completed' : '')]">
                        <div class="step-header" @click="toggleStep(1)">
                            <div class="step-icon bg-slate-800 text-slate-400"><i class="ph ph-aperture"></i></div>
                            <div class="flex-1">
                                <h3 class="font-bold text-slate-200 text-lg">{{ STEPS_CONFIG[0].fullTitle }}</h3>
                                <p v-if="currentStep === 1" class="text-sm text-slate-500 mt-1">输入 DOI，构建知识星图。</p>
                            </div>
                            <i v-if="currentStep > 1" class="ph ph-check-circle text-green-500 text-2xl"></i>
                        </div>
                        <div v-show="currentStep === 1 || activeProject.stepData[1].done" class="px-6 pb-8 border-t border-slate-700 pt-6 bg-[#0b1120]">
                            <div v-if="!activeProject.stepData[1].done" class="flex gap-3 mb-6 max-w-2xl">
                                <input v-model="activeProject.doi" type="text" class="input-dark flex-1 rounded-xl px-5 py-3" placeholder="例如: 10.1038/nature14539">
                                <button @click="runStep1" :disabled="loading" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 disabled:opacity-50">开始分析</button>
                            </div>
                            <p v-if="activeProject.stepData[1].error" class="text-red-400 text-sm mb-4">{{ activeProject.stepData[1].error }}</p>
                            <div v-if="activeProject.stepData[1].result" class="space-y-6">
                                <div class="glass-card p-6">
                                    <div class="flex flex-col md:flex-row gap-8 items-start">
                                        <div class="flex-1">
                                            <div class="flex items-start justify-between mb-4">
                                                <span class="bg-blue-900/50 text-blue-300 text-xs font-bold px-2 py-1 rounded border border-blue-800">SEED PAPER</span>
                                                <a :href="`https://doi.org/${activeProject.doi}`" target="_blank" class="text-slate-500 hover:text-blue-400"><i class="ph ph-arrow-square-out text-xl"></i></a>
                                            </div>
                                            <h4 class="font-bold text-slate-100 text-xl mb-3 leading-tight">{{ activeProject.title }}</h4>
                                            <div class="flex gap-4 text-sm text-slate-400">
                                                <span class="flex items-center gap-1"><i class="ph ph-calendar-blank"></i> {{ activeProject.stepData[1].year }}</span>
                                                <span class="flex items-center gap-1"><i class="ph ph-quotes"></i> Citations: {{ activeProject.stepData[1].citations }}</span>
                                            </div>
                                        </div>
                                        <div class="flex-1 w-full min-h-[200px] bg-slate-900/30 rounded-lg border border-slate-800 p-2">
                                            <div id="historyChartDiv" class="w-full h-full"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="glass-card p-1 relative h-[600px]">
                                    <div class="absolute top-4 left-4 z-10 bg-slate-900/80 backdrop-blur px-3 py-1.5 rounded-lg border border-slate-700 text-xs font-bold text-slate-400 flex items-center gap-2"><i class="ph ph-graph text-blue-400"></i> Citation Galaxy</div>
                                    <div id="graphDiv" class="w-full h-full rounded-xl bg-[#0b1120]"></div>
                                    <div class="absolute bottom-4 right-4 text-xs text-slate-500 bg-slate-900/50 px-2 py-1 rounded border border-slate-800"><i class="ph ph-mouse-left"></i> Click to open | Scroll to zoom</div>
                                </div>
                                <div class="glass-card p-6 border-l-4 border-blue-500">
                                    <h4 class="font-bold text-slate-200 mb-4 flex items-center gap-2"><i class="ph ph-strategy text-blue-400"></i> AI 战略纪要</h4>
                                    <div v-if="activeProject.stepData[1].analysis" class="prose-invert text-sm text-slate-300" v-html="renderMarkdown(activeProject.stepData[1].analysis)"></div>
                                    <div v-else class="flex items-center gap-2 text-slate-500 text-sm animate-pulse"><i class="ph ph-spinner animate-spin"></i> 正在生成领域分析...</div>
                                </div>
                                <div v-if="currentStep === 1" class="text-right"><button @click="nextStep" class="text-blue-400 font-bold hover:underline">下一步 <i class="ph ph-arrow-down"></i></button></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: 显微镜 -->
                    <div id="step-2" :class="['step-card', currentStep === 2 ? 'active' : (currentStep > 2 ? 'completed' : '')]">
                        <div class="step-header" @click="toggleStep(2)">
                            <div class="step-icon bg-slate-800 text-slate-400"><i class="ph ph-microscope"></i></div>
                            <div class="flex-1"><h3 class="font-bold text-slate-200 text-lg">{{ STEPS_CONFIG[1].fullTitle }}</h3></div>
                            <i v-if="currentStep > 2" class="ph ph-check-circle text-green-500 text-2xl"></i>
                        </div>
                        <div v-show="currentStep === 2 || activeProject.stepData[2].done" class="px-6 pb-8 border-t border-slate-700 pt-6 bg-[#0b1120]">
                            <div v-if="!activeProject.stepData[2].done" class="mb-6">
                                <div class="flex gap-3 mb-3">
                                    <input v-model="activeProject.searchQuery" type="text" class="input-dark flex-1 rounded-xl px-5 py-3" placeholder="输入细分方向关键词 (默认使用种子文献标题)">
                                    <button @click="runStep2" :disabled="loading" class="bg-purple-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-purple-700 disabled:opacity-50 flex items-center gap-2 transition-all"><i class="ph ph-scan"></i> 扫描前沿缺口</button>
                                </div>
                                <p class="text-xs text-slate-500"><i class="ph ph-info"></i> 系统将自动阅读相关度最高的 10 篇文献摘要，提炼核心矛盾。</p>
                            </div>
                            <div v-if="activeProject.stepData[2].result">
                                <div class="flex items-center justify-between mb-6">
                                    <h4 class="font-bold text-slate-300 flex items-center gap-2"><i class="ph ph-kanban text-purple-400"></i> 发现 {{ activeProject.stepData[2].gaps.length }} 个关键缺口</h4>
                                    <span class="text-xs text-slate-500 bg-slate-800 px-2 py-1 rounded">基于 OpenAlex 实时数据</span>
                                </div>
                                <div class="grid grid-cols-1 gap-4 mb-6">
                                    <div v-for="(item, idx) in activeProject.stepData[2].gaps" :key="idx" @click="selectGap(idx)" :class="['p-5 rounded-xl border transition-all cursor-pointer relative group', item.selected ? 'bg-purple-900/20 border-purple-500 ring-1 ring-purple-500' : 'bg-slate-800 border-slate-700 hover:border-purple-500/50']">
                                        <div v-if="item.selected" class="absolute top-4 right-4 text-purple-400"><i class="ph-fill ph-check-circle text-xl"></i></div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div class="border-r border-slate-700/50 pr-6">
                                                <div class="flex items-center gap-2 mb-2"><span class="bg-blue-900/30 text-blue-400 text-[10px] font-bold px-2 py-0.5 rounded uppercase">Current Status</span></div>
                                                <p class="text-slate-300 text-sm leading-relaxed">{{ item.status }}</p>
                                            </div>
                                            <div>
                                                <div class="flex items-center gap-2 mb-2"><span class="bg-red-900/30 text-red-400 text-[10px] font-bold px-2 py-0.5 rounded uppercase">Identified Gap</span></div>
                                                <p class="text-slate-200 text-sm font-medium leading-relaxed">{{ item.gap }}</p>
                                            </div>
                                        </div>
                                        <div class="mt-4 pt-3 border-t border-slate-700/50 flex items-center gap-2 text-xs text-slate-500"><i class="ph ph-article"></i> 来源: {{ item.source }}</div>
                                    </div>
                                </div>
                                <div v-if="currentStep === 2 && activeProject.stepData[2].done" class="flex justify-end items-center gap-4">
                                    <span class="text-xs text-slate-400" v-if="selectedGapIndex === -1">请点击选择一个核心缺口</span>
                                    <button @click="nextStep" :disabled="selectedGapIndex === -1" :class="['px-6 py-2 rounded-lg font-bold transition-colors flex items-center gap-2', selectedGapIndex !== -1 ? 'bg-purple-600 text-white hover:bg-purple-500' : 'bg-slate-700 text-slate-500 cursor-not-allowed']">基于此缺口定义 SPARK <i class="ph ph-arrow-down"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: 孵化器 -->
                    <div id="step-3" :class="['step-card', currentStep === 3 ? 'active' : (currentStep > 3 ? 'completed' : '')]">
                        <div class="step-header" @click="toggleStep(3)">
                            <div class="step-icon bg-slate-800 text-slate-400"><i class="ph ph-lightning"></i></div>
                            <div class="flex-1"><h3 class="font-bold text-slate-200 text-lg">{{ STEPS_CONFIG[2].fullTitle }}</h3></div>
                            <i v-if="currentStep > 3" class="ph ph-check-circle text-green-500 text-2xl"></i>
                        </div>
                        <div v-show="currentStep === 3 || activeProject.stepData[3].done" class="px-6 pb-8 border-t border-slate-700 pt-6 bg-[#0b1120]">
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-6">
                                <div v-for="(conf, key) in sparkSchema" :key="key" class="bg-slate-800 rounded-xl border border-slate-700 shadow-sm flex flex-col h-full group">
                                    <div :class="`h-1.5 w-full bg-${conf.color}-500`"></div>
                                    <div class="p-4 flex-1 flex flex-col">
                                        <div class="flex items-center gap-2 mb-3">
                                            <div :class="`w-8 h-8 rounded-lg bg-${conf.color}-900/30 text-${conf.color}-400 flex items-center justify-center`"><i :class="['ph-bold text-lg', conf.icon]"></i></div>
                                            <div><div :class="`font-bold text-${conf.color}-400 text-lg leading-none`">{{ key }}</div><div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">{{ conf.label }}</div></div>
                                        </div>
                                        <div v-if="activeProject.stepData[3].spark && activeProject.stepData[3].spark[key]" class="flex-1"><p class="text-sm text-slate-300 leading-relaxed font-medium">{{ activeProject.stepData[3].spark[key] }}</p></div>
                                        <div v-else class="flex-1 flex items-center justify-center text-center py-4"><span class="text-xs text-slate-600 italic">{{ conf.placeholder }}</span></div>
                                    </div>
                                </div>
                            </div>
                            <div v-if="!activeProject.stepData[3].done" class="mb-2 text-center">
                                <button @click="runStep3Spark" :disabled="loading" class="bg-white text-slate-900 px-8 py-3 rounded-xl font-bold hover:bg-blue-50 disabled:opacity-50 flex items-center justify-center gap-2 mx-auto transition-colors"><i class="ph ph-sparkle"></i> AI 智能提取 SPARK 定义</button>
                            </div>
                            <p v-if="activeProject.stepData[3].error" class="text-red-400 text-sm mb-4 text-center">{{ activeProject.stepData[3].error }}</p>
                            <div v-if="activeProject.stepData[3].done" class="bg-slate-800/50 rounded-lg p-4 border border-slate-700 mb-4">
                                <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-blue-400 flex items-center gap-2"><i class="ph ph-pencil-simple"></i> 合成研究问题 (可人工修订)</span></div>
                                <textarea v-model="activeProject.stepData[3].question" rows="2" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-slate-200 text-sm focus:border-blue-500 outline-none resize-none transition-colors"></textarea>
                            </div>
                            <div v-if="currentStep === 3 && activeProject.stepData[3].done" class="mt-4 text-right"><button @click="nextStep" class="text-white font-bold hover:text-blue-400 flex items-center justify-end gap-1 ml-auto">确认并进入检索方案 <i class="ph ph-arrow-right"></i></button></div>
                        </div>
                    </div>

                    <!-- Step 4: 蓝图 -->
                    <div id="step-4" :class="['step-card', currentStep === 4 ? 'active' : (currentStep > 4 ? 'completed' : '')]">
                        <div class="step-header" @click="toggleStep(4)">
                            <div class="step-icon bg-slate-800 text-slate-400"><i class="ph ph-compass"></i></div>
                            <div class="flex-1"><h3 class="font-bold text-slate-200 text-lg">{{ STEPS_CONFIG[3].fullTitle }}</h3></div>
                            <i v-if="currentStep > 4" class="ph ph-check-circle text-green-500 text-2xl"></i>
                        </div>
                        <div v-show="currentStep === 4 || activeProject.stepData[4].done" class="px-6 pb-8 border-t border-slate-700 pt-6 bg-[#0b1120]">
                            <div v-if="!activeProject.stepData[4].result" class="mb-2">
                                <button @click="runStep4" :disabled="loading" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 disabled:opacity-50">生成检索蓝图</button>
                            </div>
                            <p v-if="activeProject.stepData[4].error" class="text-red-400 text-sm mb-4">{{ activeProject.stepData[4].error }}</p>
                            <div v-if="activeProject.stepData[4].result">
                                <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6 text-sm space-y-5 mb-6">
                                    <div><span class="font-bold text-slate-300 block mb-1">研究问题:</span> <span class="text-slate-400">{{ activeProject.stepData[4].parsedScheme.question }}</span></div>
                                    <div class="bg-slate-900/50 p-4 rounded-lg border border-indigo-900/50">
                                        <div class="flex justify-between items-center mb-2"><span class="font-bold text-indigo-400 flex items-center gap-2"><i class="ph ph-terminal-window"></i> OpenAlex 执行指令 (机器码)</span><span class="text-[10px] bg-indigo-900/30 text-indigo-300 px-2 py-0.5 rounded border border-indigo-800">可编辑</span></div>
                                        <div class="relative"><span class="absolute left-3 top-2.5 text-indigo-500 select-none">></span><input v-model="activeProject.stepData[4].parsedScheme.openAlexQuery" class="w-full bg-slate-950 border border-slate-700 rounded-md py-2 pl-6 pr-3 text-indigo-200 font-mono text-xs focus:border-indigo-500 outline-none transition-colors" placeholder="输入 OpenAlex 检索式..." /></div>
                                    </div>
                                </div>
                                <div v-if="currentStep === 4 && activeProject.stepData[4].done" class="mt-4 text-right"><button @click="nextStep" class="text-indigo-400 font-bold hover:underline">下一步 <i class="ph ph-arrow-down"></i></button></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5: 云端执行 -->
                    <div id="step-5" :class="['step-card', currentStep === 5 ? 'active' : (currentStep > 5 ? 'completed' : '')]">
                        <div class="step-header" @click="toggleStep(5)">
                            <div class="step-icon bg-slate-800 text-slate-400"><i class="ph ph-cloud-arrow-down"></i></div>
                            <div class="flex-1"><h3 class="font-bold text-slate-200 text-lg">{{ STEPS_CONFIG[4].fullTitle }}</h3></div>
                            <i v-if="currentStep > 5" class="ph ph-check-circle text-green-500 text-2xl"></i>
                        </div>
                        <div v-show="currentStep === 5 || activeProject.stepData[5].done" class="px-6 pb-8 border-t border-slate-700 pt-6 bg-[#0b1120]">
                            <div v-if="!activeProject.stepData[5].done" class="glass-card p-6 mb-2 border-l-4 border-l-blue-500">
                                <h4 class="font-bold text-slate-200 mb-2">准备执行云端检索</h4>
                                <p class="text-sm text-slate-400 mb-4">系统将使用 Step 4 中您确认的指令，自动从 OpenAlex 抓取真实文献，并清洗摘要构建证据矩阵。</p>
                                <button @click="runStep5" :disabled="loading" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 w-full justify-center"><i class="ph ph-rocket-launch"></i> 启动云端执行</button>
                            </div>
                            <p v-if="activeProject.stepData[5].error" class="text-red-400 text-sm mb-4">{{ activeProject.stepData[5].error }}</p>
                            <div v-if="activeProject.stepData[5].evidence && activeProject.stepData[5].evidence.length > 0">
                                <div class="flex justify-between items-center mb-4"><h4 class="font-bold text-slate-300">证据矩阵 (已选 {{ selectedEvidenceCount }} / {{ activeProject.stepData[5].evidence.length }})</h4></div>
                                <div class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                                    <div v-for="(paper, idx) in activeProject.stepData[5].evidence" :key="paper.id" :class="['evidence-item p-4 rounded-lg border transition-all', paper.selected ? 'bg-slate-800 border-blue-500 ring-1 ring-blue-500' : 'bg-slate-800 border-slate-700 opacity-70']">
                                        <div class="flex gap-3 cursor-pointer" @click="togglePaper(idx)">
                                            <div :class="['w-5 h-5 rounded border flex items-center justify-center flex-shrink-0 mt-1', paper.selected ? 'bg-blue-600 border-blue-600' : 'border-slate-500']"><i v-if="paper.selected" class="ph ph-check text-white text-xs"></i></div>
                                            <div class="flex-1">
                                                <div class="font-bold text-slate-200 text-sm mb-1">{{ paper.title }}</div>
                                                <div class="text-xs text-slate-400 mb-2">{{ paper.publication_year }} · <a :href="paper.url" target="_blank" @click.stop class="text-blue-400 hover:underline flex-inline items-center gap-1"><i class="ph ph-arrow-square-out"></i> 阅读原文</a></div>
                                                <div class="text-xs text-slate-500 line-clamp-2 mb-2">{{ paper.abstract }}</div>
                                            </div>
                                        </div>
                                        <div v-if="paper.selected" class="mt-3 pt-3 border-t border-slate-700/50 pl-8">
                                            <div class="flex items-center justify-between mb-2"><span class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider flex items-center gap-1"><i class="ph ph-flask"></i> 补充 Methods / Key Data</span><span class="text-[10px] text-slate-600">可选</span></div>
                                            <textarea v-model="paper.user_notes" class="w-full bg-slate-900/50 border border-slate-700 rounded p-2 text-xs text-slate-300 focus:border-indigo-500 outline-none transition-colors" rows="2" placeholder="在此粘贴原文中的关键方法、参数或实验数据..."></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="currentStep === 5" class="mt-6 text-right"><button @click="nextStep" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-500 transition-colors">确认证据并进入写作 <i class="ph ph-arrow-right"></i></button></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 6: 写作助手 -->
                    <div id="step-6" :class="['step-card', currentStep === 6 ? 'active' : (currentStep > 6 ? 'completed' : '')]">
                        <div class="step-header" @click="toggleStep(6)">
                            <div class="step-icon bg-slate-800 text-slate-400"><i class="ph ph-pen-nib"></i></div>
                            <div class="flex-1"><h3 class="font-bold text-slate-200 text-lg">{{ STEPS_CONFIG[5].fullTitle }}</h3></div>
                            <i v-if="currentStep > 6" class="ph ph-check-circle text-green-500 text-2xl"></i>
                        </div>
                        <div v-show="currentStep === 6 || activeProject.stepData[6].done" class="px-6 pb-8 border-t border-slate-700 pt-6 bg-[#0b1120]">
                            <p v-if="activeProject.stepData[6].error" class="text-red-400 text-sm mb-4">{{ activeProject.stepData[6].error }}</p>

                            <div v-if="!activeProject.stepData[6].status || activeProject.stepData[6].status === 'idle'" class="mb-4">
                                <div class="bg-blue-900/20 border border-blue-800 p-6 rounded-2xl mb-6 text-center">
                                    <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/30"><i class="ph ph-brain text-3xl text-white"></i></div>
                                    <h4 class="text-xl font-bold text-white mb-2">准备进行深度合成写作</h4>
                                    <p class="text-slate-400 text-sm mb-6 max-w-lg mx-auto">AI 将基于 SPARK 逻辑和 {{ selectedEvidenceCount }} 篇真实文献，采用“分治法”策略：先规划大纲，再逐章撰写，最后合成全文。</p>
                                    <button @click="generateOutline" :disabled="loading" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-500 disabled:opacity-50 transition-all transform hover:scale-105"><i class="ph ph-list-dashes"></i> 生成写作大纲</button>
                                </div>
                            </div>

                            <div v-if="activeProject.stepData[6].status === 'outlining'" class="mb-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-bold text-slate-300">确认写作大纲</h4>
                                    <button @click="startWriting" :disabled="loading" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-500">确认并开始撰写 <i class="ph ph-play"></i></button>
                                </div>
                                <div class="bg-slate-800 rounded-xl border border-slate-700 p-4 space-y-3">
                                    <div v-for="(chapter, idx) in activeProject.stepData[6].outline" :key="idx" class="flex items-center gap-3">
                                        <span class="text-slate-500 font-mono text-xs w-6">{{ idx + 1 }}.</span>
                                        <input v-model="chapter.title" class="flex-1 bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-slate-200 focus:border-blue-500 outline-none" />
                                        <button @click="removeChapter(idx)" class="text-red-400 hover:text-red-300"><i class="ph ph-trash"></i></button>
                                    </div>
                                    <button @click="addChapter" class="w-full py-2 border-2 border-dashed border-slate-600 rounded-lg text-slate-500 text-sm hover:border-slate-500 hover:text-slate-400 transition-colors">+ 添加章节</button>
                                </div>
                            </div>

                            <div v-if="activeProject.stepData[6].status === 'writing' || activeProject.stepData[6].status === 'finished'" class="flex h-[600px] gap-6">
                                <div class="w-1/3 bg-slate-800 rounded-xl border border-slate-700 p-4 overflow-y-auto">
                                    <h5 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Writing Progress</h5>
                                    <div class="space-y-0">
                                        <div v-for="(chapter, idx) in activeProject.stepData[6].outline" :key="idx" class="outline-node flex items-start gap-3 pb-6 last:pb-0">
                                            <div :class="['status-dot flex-shrink-0', chapter.status]">
                                                <i v-if="chapter.status === 'done'" class="ph-bold ph-check"></i>
                                                <i v-else-if="chapter.status === 'writing'" class="ph-bold ph-spinner animate-spin"></i>
                                                <span v-else class="w-1.5 h-1.5 bg-current rounded-full"></span>
                                            </div>
                                            <div>
                                                <div :class="['text-sm font-bold transition-colors', chapter.status === 'writing' ? 'text-blue-400' : (chapter.status === 'done' ? 'text-slate-300' : 'text-slate-500')]">{{ chapter.title }}</div>
                                                <div class="text-xs text-slate-500 mt-1">{{ chapter.status === 'done' ? '已完成' : (chapter.status === 'writing' ? '正在撰写...' : '等待中') }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-1 bg-slate-900 rounded-xl border border-slate-700 p-8 overflow-y-auto shadow-inner relative">
                                    <div v-if="activeProject.stepData[6].finalDraft" class="prose-invert max-w-none" v-html="renderMarkdown(activeProject.stepData[6].finalDraft)"></div>
                                    <div v-else class="flex flex-col items-center justify-center h-full text-slate-600"><i class="ph ph-typewriter text-4xl mb-2"></i><p>等待写入...</p></div>
                                    <div v-if="activeProject.stepData[6].status === 'finished'" class="absolute top-4 right-4 flex gap-2">
                                        <button @click="exportReport" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-blue-500 transition-colors"><i class="ph ph-download-simple"></i> 导出全文</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        window.onerror = function(msg, url, line) {
            document.getElementById('error-overlay').style.display = 'block';
            document.getElementById('error-msg').innerText = `${msg}\nLine: ${line}`;
        };
    </script>
    <script type="module" src="./src/main.js"></script>
</body>
</html>
